<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理后台</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>数据管理后台</h1>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('words')">单词管理</button>
            <button class="tab-btn" onclick="showTab('records')">练习记录</button>
            <button class="tab-btn" onclick="showTab('backup')">数据备份</button>
        </div>

        <!-- 单词管理 -->
        <div id="wordsTab" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">单词管理</h2>
                <div class="action-bar">
                    <button class="btn btn-primary" onclick="showEditModal(null)">
                        <span>添加新单词</span>
                    </button>
                    <button class="btn btn-info" onclick="showBatchAddModal()">
                        <span>批量添加</span>
                    </button>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="toggleBatchMode()">
                        <span id="batchModeText">批量管理</span>
                    </button>
                </div>
            </div>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="batch-column" style="display: none; width: 40px;">
                                <input type="checkbox" id="selectAllWords" onchange="toggleSelectAllWords()">
                            </th>
                            <th>单词</th>
                            <th>翻译</th>
                            <th>练习次数</th>
                            <th>错误次数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="wordsTable"></tbody>
                </table>
            </div>
            <div class="batch-actions" style="display: none;">
                <button class="btn btn-delete-large" onclick="batchDeleteWords()">批量删除选中项</button>
            </div>
        </div>

        <!-- 练习记录 -->
        <div id="recordsTab" class="tab-content" style="display:none">
            <div class="section-header">
                <h2 class="section-title">练习记录</h2>
                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="toggleBatchModeRecords()">
                        <span id="batchModeRecordsText">批量管理</span>
                    </button>
                </div>
            </div>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="batch-column-records" style="display: none; width: 40px;">
                                <input type="checkbox" id="selectAllRecords" onchange="toggleSelectAllRecords()">
                            </th>
                            <th>日期</th>
                            <th>状态</th>
                            <th>单词</th>
                            <th>模式</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- 数据备份 -->
        <div id="backupTab" class="tab-content" style="display:none">
            <div class="section-header">
                <h2 class="section-title">数据管理</h2>
            </div>

            <div class="file-input-container">
                <div>
                    <h3 class="file-input-header">导出数据</h3>
                    <div class="file-input-group">
                        <button class="btn btn-success" onclick="exportData()">导出所有数据</button>
                        <p class="file-info">导出包含单词库和练习记录的 JSON 文件</p>
                    </div>
                </div>

                <div>
                    <h3 class="file-input-header">导入数据</h3>
                    <div class="file-input-group">
                        <label class="custom-file-input">
                            <input type="file" id="fileInput" accept=".json" onchange="handleFileSelect(event)">
                            <div>点击选择文件或拖拽文件至此</div>
                            <p class="file-info">支持 JSON 格式文件</p>
                        </label>
                    </div>
                </div>

                <div>
                    <h3 class="file-input-header">清空数据</h3>
                    <div class="file-input-group">
                        <button class="btn btn-delete-large" onclick="clearAllData()">清空所有数据</button>
                        <p class="file-info" style="color: var(--error);">此操作不可撤销，请谨慎操作</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑单词模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">添加新单词</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="wordInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">单词:</label>
                <input type="text" id="wordInput" class="form-control" placeholder="输入英文单词">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="translationsInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">翻译:</label>
                <input type="text" id="translationsInput" class="form-control" placeholder="输入中文翻译，多个翻译用逗号分隔">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                <button class="btn btn-primary" onclick="saveWord()">保存</button>
            </div>
        </div>
    </div>

    <!-- 批量添加模态框 -->
    <div id="batchAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">批量添加单词</h3>
                <span class="close" onclick="closeBatchAddModal()">&times;</span>
            </div>
            <div class="format-help">
                <p>数据格式说明：</p>
                <pre>单词1,翻译1,翻译2
单词2,翻译1
单词3,翻译1,翻译2,翻译3</pre>
                <p style="margin-top: 0.5rem; color: #64748b;">每行一个单词，用逗号分隔单词和翻译，多个翻译之间也用逗号分隔</p>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="batchData" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">批量数据:</label>
                <textarea id="batchData" class="form-control" rows="8" placeholder="粘贴数据..."></textarea>
            </div>

            <div class="form-actions">
                <button class="btn btn-delete-large" onclick="closeBatchAddModal()">取消</button>
                <button class="btn btn-primary" onclick="processBatchAdd()">导入</button>
            </div>
        </div>
    </div>

    <!-- Toast通知容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="assets/js/common.js"></script>
    <script>
        let currentEditIndex = -1;

        // Tab management
        const showTab = (tabName) => {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Add active class to clicked button
            event.target.classList.add('active');

            // Refresh data for the selected tab
            if (tabName === 'words') {
                refreshWords();
            } else if (tabName === 'records') {
                refreshRecords();
            }
        };

        // Word management functions
        const refreshWords = () => {
            const wordBank = getWordBank();
            const tableBody = document.getElementById('wordsTable');
            
            tableBody.innerHTML = '';

            wordBank.forEach((word, index) => {
                const contextStats = word.modes?.context || { errors: 0, practiceCount: 0 };
                const blankStats = word.modes?.blank || { errors: 0, practiceCount: 0 };
                const totalPractice = contextStats.practiceCount + blankStats.practiceCount;
                const totalErrors = contextStats.errors + blankStats.errors;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="batch-column" style="display: none;">
                        <input type="checkbox" class="word-checkbox batch-checkbox" data-index="${index}">
                    </td>
                    <td style="font-weight: 600; color: var(--primary);">${word.word}</td>
                    <td>${word.translations.join(', ')}</td>
                    <td>${totalPractice}</td>
                    <td>${totalErrors}</td>
                    <td>
                        <button class="btn btn-small btn-info" onclick="showEditModal(${index})">编辑</button>
                        <button class="btn btn-small btn-delete" onclick="deleteWord(${index})">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        const showEditModal = (index) => {
            currentEditIndex = index;
            const modal = document.getElementById('editModal');
            const modalTitle = document.getElementById('modalTitle');
            const wordInput = document.getElementById('wordInput');
            const translationsInput = document.getElementById('translationsInput');

            if (index === null) {
                // Adding new word
                modalTitle.textContent = '添加新单词';
                wordInput.value = '';
                translationsInput.value = '';
            } else {
                // Editing existing word
                const wordBank = getWordBank();
                const word = wordBank[index];
                modalTitle.textContent = '编辑单词';
                wordInput.value = word.word;
                translationsInput.value = word.translations.join(', ');
            }

            modal.style.display = 'block';
        };

        const closeEditModal = () => {
            document.getElementById('editModal').style.display = 'none';
        };

        const saveWord = () => {
            const wordInput = document.getElementById('wordInput');
            const translationsInput = document.getElementById('translationsInput');

            const word = wordInput.value.trim();
            const translations = translationsInput.value.trim().split(',').map(t => t.trim()).filter(t => t);

            if (!word || translations.length === 0) {
                showToast('请输入单词和翻译', 'error');
                return;
            }

            const wordBank = getWordBank();

            // Check for duplicates (except when editing the same word)
            const existingIndex = wordBank.findIndex(w => w.word.toLowerCase() === word.toLowerCase());
            if (existingIndex !== -1 && existingIndex !== currentEditIndex) {
                showToast('单词已存在', 'error');
                return;
            }

            const wordObj = {
                word: word,
                translations: translations,
                modes: {
                    context: { errors: 0, practiceCount: 0 },
                    blank: { errors: 0, practiceCount: 0 }
                }
            };

            if (currentEditIndex === null) {
                // Adding new word
                wordBank.push(wordObj);
                showToast('单词添加成功', 'success');
            } else {
                // Editing existing word - preserve practice stats
                const existingWord = wordBank[currentEditIndex];
                wordObj.modes = existingWord.modes || wordObj.modes;
                wordBank[currentEditIndex] = wordObj;
                showToast('单词更新成功', 'success');
            }

            saveWordBank(wordBank);
            refreshWords();
            closeEditModal();
        };

        const deleteWord = (index) => {
            if (!confirm('确定要删除这个单词吗？')) return;

            const wordBank = getWordBank();
            wordBank.splice(index, 1);
            saveWordBank(wordBank);
            refreshWords();
            showToast('单词删除成功', 'success');
        };

        // Batch operations
        const toggleBatchMode = () => {
            const batchColumns = document.querySelectorAll('.batch-column');
            const batchActions = document.querySelector('.batch-actions');
            const batchModeText = document.getElementById('batchModeText');
            const isInBatchMode = batchColumns[0].style.display === 'table-cell';

            if (isInBatchMode) {
                // Exit batch mode
                batchColumns.forEach(col => col.style.display = 'none');
                batchActions.style.display = 'none';
                batchModeText.textContent = '批量管理';
            } else {
                // Enter batch mode
                batchColumns.forEach(col => col.style.display = 'table-cell');
                batchActions.style.display = 'block';
                batchModeText.textContent = '退出批量管理';
                // Uncheck all
                document.querySelectorAll('.word-checkbox').forEach(checkbox => checkbox.checked = false);
                document.getElementById('selectAllWords').checked = false;
            }

            refreshWords();
        };

        const toggleSelectAllWords = () => {
            const selectAll = document.getElementById('selectAllWords');
            const checkboxes = document.querySelectorAll('.word-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        };

        const batchDeleteWords = () => {
            const checkboxes = document.querySelectorAll('.word-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('请选择要删除的单词', 'error');
                return;
            }

            if (!confirm(`确定要删除选中的 ${checkboxes.length} 个单词吗？`)) return;

            const wordBank = getWordBank();
            const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);

            indicesToDelete.forEach(index => {
                wordBank.splice(index, 1);
            });

            saveWordBank(wordBank);
            refreshWords();
            showToast(`成功删除 ${indicesToDelete.length} 个单词`, 'success');
        };

        // Batch add functionality
        const showBatchAddModal = () => {
            document.getElementById('batchAddModal').style.display = 'block';
        };

        const closeBatchAddModal = () => {
            document.getElementById('batchAddModal').style.display = 'none';
            document.getElementById('batchData').value = '';
        };

        const processBatchAdd = () => {
            const batchData = document.getElementById('batchData').value.trim();
            if (!batchData) {
                showToast('请输入数据', 'error');
                return;
            }

            const lines = batchData.split('\n').filter(line => line.trim());
            const wordBank = getWordBank();
            let addedCount = 0;
            let skippedCount = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(part => part.trim()).filter(part => part);
                if (parts.length < 2) return;

                const word = parts[0];
                const translations = parts.slice(1);

                // Check for duplicates
                if (wordBank.some(w => w.word.toLowerCase() === word.toLowerCase())) {
                    skippedCount++;
                    return;
                }

                wordBank.push({
                    word: word,
                    translations: translations,
                    modes: {
                        context: { errors: 0, practiceCount: 0 },
                        blank: { errors: 0, practiceCount: 0 }
                    }
                });
                addedCount++;
            });

            saveWordBank(wordBank);
            refreshWords();
            closeBatchAddModal();

            let message = `成功添加 ${addedCount} 个单词`;
            if (skippedCount > 0) {
                message += `，跳过 ${skippedCount} 个重复单词`;
            }
            showToast(message, 'success');
        };

        // Records management
        const refreshRecords = () => {
            const records = getPracticeRecords();
            const tableBody = document.getElementById('recordsTable');
            
            tableBody.innerHTML = '';

            records.slice().reverse().forEach((record, index) => {
                const row = document.createElement('tr');
                const statusIcon = record.isCorrect ? '✓' : '✗';
                const statusColor = record.isCorrect ? 'var(--success)' : 'var(--error)';

                row.innerHTML = `
                    <td class="batch-column-records" style="display: none;">
                        <input type="checkbox" class="record-checkbox batch-checkbox" data-index="${records.length - 1 - index}">
                    </td>
                    <td>${record.date}</td>
                    <td style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${record.isCorrect ? '正确' : '错误'}</td>
                    <td style="font-weight: 600;">${record.word}</td>
                    <td>${record.mode}</td>
                    <td>
                        <button class="btn btn-small btn-delete" onclick="deleteRecord(${records.length - 1 - index})">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        const deleteRecord = (index) => {
            if (!confirm('确定要删除这条记录吗？')) return;

            const records = getPracticeRecords();
            records.splice(index, 1);
            localStorage.setItem('practiceRecords', JSON.stringify(records));
            refreshRecords();
            showToast('记录删除成功', 'success');
        };

        const toggleBatchModeRecords = () => {
            const batchColumns = document.querySelectorAll('.batch-column-records');
            const batchModeText = document.getElementById('batchModeRecordsText');
            const isInBatchMode = batchColumns[0].style.display === 'table-cell';

            if (isInBatchMode) {
                batchColumns.forEach(col => col.style.display = 'none');
                batchModeText.textContent = '批量管理';
            } else {
                batchColumns.forEach(col => col.style.display = 'table-cell');
                batchModeText.textContent = '退出批量管理';
                document.querySelectorAll('.record-checkbox').forEach(checkbox => checkbox.checked = false);
                document.getElementById('selectAllRecords').checked = false;
            }

            refreshRecords();
        };

        const toggleSelectAllRecords = () => {
            const selectAll = document.getElementById('selectAllRecords');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        };

        // Data management
        const exportData = () => {
            const data = {
                wordBank: getWordBank(),
                practiceRecords: getPracticeRecords(),
                supportedModes: JSON.parse(localStorage.getItem('supportedModes') || '[]'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `english-learning-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('数据导出成功', 'success');
        };

        const handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    importData(data);
                } catch (error) {
                    showToast('文件格式错误', 'error');
                }
            };
            reader.readAsText(file);
        };

        const importData = (data) => {
            if (!confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) return;

            try {
                if (data.wordBank) {
                    localStorage.setItem('wordBank', JSON.stringify(data.wordBank));
                }
                if (data.practiceRecords) {
                    localStorage.setItem('practiceRecords', JSON.stringify(data.practiceRecords));
                }
                if (data.supportedModes) {
                    localStorage.setItem('supportedModes', JSON.stringify(data.supportedModes));
                }

                refreshWords();
                refreshRecords();
                showToast('数据导入成功', 'success');
            } catch (error) {
                showToast('数据导入失败', 'error');
            }
        };

        const clearAllData = () => {
            if (!confirm('确定要清空所有数据吗？此操作不可撤销！')) return;
            if (!confirm('再次确认：真的要删除所有单词和记录吗？')) return;

            localStorage.removeItem('wordBank');
            localStorage.removeItem('practiceRecords');
            localStorage.removeItem('supportedModes');

            // Reinitialize with defaults
            initializeApp();

            refreshWords();
            refreshRecords();
            showToast('所有数据已清空', 'success');
        };

        // Modal handling
        window.onclick = (event) => {
            const editModal = document.getElementById('editModal');
            const batchModal = document.getElementById('batchAddModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === batchModal) {
                closeBatchAddModal();
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            refreshWords();
        });
    </script>
</body>

</html>